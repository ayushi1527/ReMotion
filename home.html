<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ReMotion - Galaxy Rehab AI</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  </head>
  <body>
    <div class="galaxy-bg">
      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
          getAuth,
          onAuthStateChanged,
          signOut,
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // Your Firebase config (replace with your own from Firebase Console)
        const firebaseConfig = {
          apiKey: "AIzaSyD6k5voxFW8Xfp1hD60H0bk8qxSxX1doLE",
          authDomain: "remotion-bc981.firebaseapp.com",
          projectId: "remotion-bc981",
          storageBucket: "remotion-bc981.firebasestorage.app",
          messagingSenderId: "661426663525",
          appId: "1:661426663525:web:f9e2a30d242feb5f7d968c",
          measurementId: "G-NWH9KE6Y0L",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ---- AUTH CHECK & DISPLAY userName ----
        document.addEventListener("DOMContentLoaded", () => {
          const nav = document.createElement("div");
          nav.classList.add("navbar");
          nav.style.display = "flex";
          nav.style.justifyContent = "flex-end";
          nav.style.padding = "10px 20px";
          nav.style.position = "absolute";
          nav.style.top = "0";
          nav.style.right = "0";
          nav.style.color = "white";
          nav.style.fontFamily = "Poppins, sans-serif";

          // ðŸ” Listen for Firebase Auth state
          onAuthStateChanged(auth, (user) => {
            if (user) {
              // âœ… user logged in
              const userName = user.displayName || user.email.split("@")[0]; // show email name if no displayName
              nav.innerHTML = `
          <p>Welcome, <strong>${userName}</strong></p>
          <button id="logoutBtn" style="
            margin-left: 15px;
            padding: 5px 10px;
            background: #ff7a7a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;">Logout</button>
        `;

              // Handle logout
              nav.querySelector("#logoutBtn").addEventListener("click", () => {
                signOut(auth).then(() => {
                  window.location.href = "login.html";
                });
              });
            } else {
              // ðŸš« user not logged in
              nav.innerHTML = `
          <a href="signup.html" style="
            color: white; 
            text-decoration: none;
            padding: 8px 16px; 
            background: #5A4DFE; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: background 0.3s ease; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin-right: 10px;"
            onmouseover="this.style.background='#7B6FFF';"
            onmouseout="this.style.background='#5A4DFE';"
          >Sign Up</a>

          <a href="login.html" style="
            color: white; 
            text-decoration: none;
            padding: 8px 16px; 
            background: #5A4DFE; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: background 0.3s ease; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);"
            onmouseover="this.style.background='#7B6FFF';"
            onmouseout="this.style.background='#5A4DFE';"
          >Login</a>
        `;
            }
          });

          document.body.appendChild(nav);
        });
      </script>
    </div>

    <section class="hero">
      <div class="hero-content">
        <div class="hero-left">
          <lottie-player
            src="hero-animation.json"
            background="transparent"
            speed="1"
            style="width: 400px; height: 400px; margin: auto"
            loop
            autoplay
          >
          </lottie-player>
        </div>
        <div class="hero-right">
          <h1>ReMotion</h1>
          <p>
            Track, recover, and grow stronger under the stars. Upload your
            videos, watch your progress evolve, and enjoy gamified healing.
          </p>
          <button class="btn-primary" id="open-upload-modal-hero">
            Upload Exercise Video
          </button>
        </div>
      </div>
    </section>

    <section class="features">
      <div class="feature-card">
        <h2>AI Progress Tracker</h2>
        <p>
          Our ML model converts your uploaded videos into insightful progress
          graphs and summaries over time.
        </p>
        <button class="btn-secondary" id="open-upload-modal-card">
          Upload Now
        </button>
      </div>
      <div class="feature-card">
        <h2>Guided Rehab Library</h2>
        <p>
          Watch interactive videos made for paralysis recovery. Each step is
          explained clearly to help you improve daily.
        </p>
        <a href="exercises.html" class="btn-secondary">Explore</a>
      </div>
      <div class="feature-card">
        <h2>Gamified Motivation</h2>
        <p>
          Earn stars and cosmic rewards as you complete exercises. Turn rehab
          into a fun interstellar challenge!
        </p>
        <a href="gamified.html" class="btn-secondary"
          >complete your exercises</a
        >
      </div>
    </section>

    <footer>
      <p>Â© 2025 ReMotion â€¢ Healing with us</p>
    </footer>

    <div id="analysis-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <button class="modal-close" id="modal-close-btn">&times;</button>
        <h2>AI Progress Tracker</h2>
        <p>Upload your video to get an instant analysis of your movement.</p>

        <div class="modal-upload-form">
          <input
            type="file"
            id="video-upload-input"
            accept="video/*"
            class="modal-file-input"
          />
          <button class="btn-primary" id="video-analyze-button">Analyze</button>
        </div>

        <hr class="modal-divider" />

        <div id="modal-results-area">
          <div class="spinner" id="modal-spinner" style="display: none"></div>
          <h3 id="modal-status-text">Please upload a video to begin.</h3>

          <div id="modal-report-output" style="display: none">
            <div class="report-section">
              <h4>Elbow Report</h4>
              <ul id="elbow-report-list"></ul>
              <canvas id="elbow-chart"></canvas>
            </div>
            <div class="report-section">
              <h4>Knee Report</h4>
              <ul id="knee-report-list"></ul>
              <canvas id="knee-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // --- MODAL CONTROLS ---
      const modal = document.getElementById("analysis-modal");
      // Find all buttons that should open the modal
      const openBtn1 = document.getElementById("open-upload-modal-hero");
      const openBtn2 = document.getElementById("open-upload-modal-card");
      const closeBtn = document.getElementById("modal-close-btn");

      const openModal = (e) => {
        e.preventDefault();
        modal.style.display = "flex";
      };

      openBtn1.addEventListener("click", openModal);
      openBtn2.addEventListener("click", openModal);

      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });

      // Close if user clicks outside the modal content
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });

      // --- CHART & ANALYSIS LOGIC ---
      const analyzeButton = document.getElementById("video-analyze-button");
      const videoInput = document.getElementById("video-upload-input");
      const statusText = document.getElementById("modal-status-text");
      const reportOutput = document.getElementById("modal-report-output");
      const modalSpinner = document.getElementById("modal-spinner");

      // Chart variables to destroy them later
      let elbowChart, kneeChart;

      analyzeButton.addEventListener("click", async () => {
        const file = videoInput.files[0];
        if (!file) {
          statusText.innerText = "Error: No file selected!";
          return;
        }

        const formData = new FormData();
        formData.append("video", file);

        // Show loading status
        statusText.innerText =
          "Uploading and analyzing... This may take a moment.";
        statusText.style.display = "block";
        reportOutput.style.display = "none";
        modalSpinner.style.display = "block";

        reportOutput.style.display = "none";

        try {
          // Send file to Flask server
          const response = await fetch(
            "https://remotion-backend-fch1.onrender.com/analyze",
            {
              method: "POST",
              body: formData,
            }
          );

          const data = await response.json();

          if (!response.ok) {
            statusText.innerText =
              "Server Error: " + (data.error || "Unknown error");
            modalSpinner.style.display = "none";
          } else {
            // Success! Display the results
            statusText.style.display = "none";
            modalSpinner.style.display = "none";
            reportOutput.style.display = "block";
            displayResults(data);
          }
        } catch (error) {
          statusText.innerText =
            "Network Error: Could not connect to server. Is it running?";
          modalSpinner.style.display = "none";
          console.error(error);
        }
      });

      function displayResults(results) {
        // 1. Populate Text Reports
        const elbowList = document.getElementById("elbow-report-list");
        const kneeList = document.getElementById("knee-report-list");
        elbowList.innerHTML = "";
        kneeList.innerHTML = "";

        results.suggestions.elbow_report.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          elbowList.appendChild(li);
        });

        results.suggestions.knee_report.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          kneeList.appendChild(li);
        });

        // 2. Draw Graphs
        const graphData = results.graph_data;
        const labels = graphData.time_sec; // X-axis

        if (elbowChart) elbowChart.destroy();
        if (kneeChart) kneeChart.destroy();

        // Set default font color for Chart.js using your theme
        Chart.defaults.color = "#C9C7FF";

        const chartOptions = {
          scales: {
            x: {
              title: { display: true, text: "Time (s)" },
              grid: { color: "rgba(90, 77, 254, 0.2)" }, // Theme color grid
            },
            y: {
              title: { display: true, text: "Angle (Â°)" },
              grid: { color: "rgba(90, 77, 254, 0.2)" }, // Theme color grid
            },
          },
        };

        const elbowCtx = document
          .getElementById("elbow-chart")
          .getContext("2d");
        elbowChart = new Chart(elbowCtx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Left Elbow",
                data: graphData.left_elbow,
                borderColor: "rgb(75, 192, 192)",
                tension: 0.1,
                pointRadius: 0,
              },
              {
                label: "Right Elbow",
                data: graphData.right_elbow,
                borderColor: "#D04C9C",
                tension: 0.1,
                pointRadius: 0,
              }, // Theme color
            ],
          },
          options: chartOptions,
        });

        const kneeCtx = document.getElementById("knee-chart").getContext("2d");
        kneeChart = new Chart(kneeCtx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Left Knee",
                data: graphData.left_knee,
                borderColor: "rgb(54, 162, 235)",
                tension: 0.1,
                pointRadius: 0,
              },
              {
                label: "Right Knee",
                data: graphData.right_knee,
                borderColor: "rgb(255, 159, 64)",
                tension: 0.1,
                pointRadius: 0,
              },
            ],
          },
          options: chartOptions,
        });
      }
    </script>
  </body>
</html>
